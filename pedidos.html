<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Pedido - GRANJA ABUELO FELIPE</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .font-display { font-family: 'Playfair Display', serif; }
        .font-body { font-family: 'Inter', sans-serif; }
        .btn-primary {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
        }
        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .map-container {
            display: none;
            margin-top: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .product-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .quantity-btn {
            transition: all 0.2s ease;
        }
        .quantity-btn:hover {
            background-color: #d1d5db;
        }
        #interactive-map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1;
        }
        .map-instructions {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .location-coordinates {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .custom-marker {
            background: #dc2626;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .custom-marker::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #dc2626;
        }
        .location-link {
            color: #2563eb;
            text-decoration: underline;
            word-break: break-all;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #25d366;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-message {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .payment-option {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        .payment-option.selected {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .shipping-option {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        .shipping-option.selected {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
    </style>
</head>
<body class="font-body bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg font-semibold text-gray-800">Procesando pedido...</p>
            <p class="text-gray-600">Por favor espere un momento</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                        <img src="images/Copia de Copia de Copia de Granja Abuelo Felipe (1).png" alt="Logo Granja Abuelo Felipe" class="w-15 h-15 object-contain">
                    </div>
                    <div>
                        <h1 class="font-display text-2xl font-bold text-gray-800">GRANJA ABUELO FELIPE</h1>
                        <p class="text-sm text-gray-600">Leche de Cabra Artesanal</p>
                    </div>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Inicio</a>
                    <a href="index.html#productos" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Productos</a>
                    <a href="nosotros.html" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Nosotros</a>
                    <a href="index.html#contacto" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Contacto</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-16">
        <div class="container mx-auto px-6 max-w-4xl">
            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-green-600">Información Personal</span>
                    <span class="text-sm font-medium text-gray-500">Productos</span>
                    <span class="text-sm font-medium text-gray-500">Confirmación</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 33%"></div>
                </div>
            </div>

            <!-- Paso 1: Información Personal -->
            <div id="step1" class="step active bg-white rounded-2xl shadow-lg p-8">
                <h2 class="font-display text-3xl font-bold text-gray-800 mb-2">Información del Pedido</h2>
                <p class="text-gray-600 mb-6">Complete sus datos para procesar su pedido</p>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" id="customerName" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Ingrese su nombre completo" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Número de Teléfono *</label>
                        <input type="tel" id="customerPhone" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Ej: 0981 123456" required>
                    </div>
                    
                    <!-- Ciudad con opciones mejoradas -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad *</label>
                        <select id="customerCity" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" required>
                            <option value="">Seleccione una ciudad</option>
                            <!-- Las opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                    
                    <!-- Departamento/Municipio/Distrito (se muestra dinámicamente) -->
                    <div id="locationDetails" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Departamento *</label>
                            <select id="customerDepartment" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" required>
                                <option value="">Seleccione departamento</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Distrito *</label>
                            <select id="customerDistrict" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" required>
                                <option value="">Seleccione distrito</option>
                            </select>
                        </div>
                    </div>

                    <!-- Método de Pago (solo para Coronel Oviedo) -->
                    <div id="paymentMethodContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pago *</label>
                        <div class="space-y-3">
                            <div class="payment-option rounded-lg p-4 cursor-pointer" data-value="efectivo">
                                <div class="flex items-center space-x-3">
                                    <div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full hidden"></div>
                                    </div>
                                    <span class="text-lg">💵 Efectivo al recibir</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-8 mt-1">Pague cuando reciba su pedido</p>
                            </div>
                            <div class="payment-option rounded-lg p-4 cursor-pointer" data-value="transferencia">
                                <div class="flex items-center space-x-3">
                                    <div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full hidden"></div>
                                    </div>
                                    <span class="text-lg">🏦 Transferencia bancaria</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-8 mt-1">Realice la transferencia antes de la entrega</p>
                            </div>
                        </div>
                    </div>

                    <!-- Agencia de Envío (para otras ciudades) -->
                    <div id="shippingAgencyContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Agencia de Envío *</label>
                        <select id="shippingAgency" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                            <option value="">Seleccione agencia de envío</option>
                            <option value="tcd">🚚 TCD Envíos</option>
                            <option value="las-golondrinas">🚛 Las Golondrinas</option>
                            <option value="trans-cit">🚛 Trans Cit</option>
                            <option value="express">🚀 Express Paraguay</option>
                            <option value="otra">🏪 Otra agencia</option>
                        </select>
                    </div>

                    <!-- Campo para otra agencia -->
                    <div id="otherAgencyContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Especifique la agencia *</label>
                        <input type="text" id="otherAgency" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Nombre de la agencia de envío">
                    </div>
                    
                    <!-- Mapa Interactivo para Coronel Oviedo -->
                    <div id="coronelOviedoMap" class="map-container">
                        <h4 class="font-medium text-gray-700 mb-3">Seleccione su ubicación exacta en Coronel Oviedo</h4>
                        
                        <div class="map-instructions">
                            <div class="flex items-start space-x-2">
                                <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                                <p class="text-sm text-gray-700">
                                    <strong>Instrucciones:</strong> Haga clic en el mapa para colocar el marcador en su ubicación exacta. 
                                    Puede acercar/alejar y mover el mapa para encontrar su dirección precisa.
                                </p>
                            </div>
                        </div>
                        
                        <div id="interactive-map"></div>
                        
                        <div class="location-coordinates">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-map-marker-alt text-red-500"></i>
                                <span class="font-medium">Ubicación seleccionada:</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Latitud:</span>
                                    <span id="selected-lat" class="font-mono">-25.4481</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Longitud:</span>
                                    <span id="selected-lng" class="font-mono">-56.4428</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <span class="text-gray-600">Dirección aproximada:</span>
                                <span id="selected-address" class="font-medium">Centro de Coronel Oviedo</span>
                            </div>
                            <div class="mt-2" id="location-link-container">
                                <span class="text-gray-600">Enlace de ubicación:</span>
                                <a id="location-link" href="#" target="_blank" class="location-link text-sm">
                                    https://maps.google.com/?q=-25.4481,-56.4428
                                </a>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Referencia adicional (opcional)</label>
                            <input type="text" id="locationReference" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Ej: Casa color azul, portón negro, a 2 cuadras del supermercado">
                        </div>
                    </div>
                    
                    <!-- Campo de referencia para otras ciudades -->
                    <div id="otherCityReference" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dirección/Referencia *</label>
                        <textarea id="locationReferenceOther" rows="3" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Ej: Barrio San Miguel, casa color azul, a 2 cuadras del supermercado..." required></textarea>
                    </div>
                    
                    <div class="flex justify-end mt-8">
                        <button id="nextToStep2" class="btn-primary flex items-center">
                            Continuar a Productos <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Paso 2: Productos -->
            <div id="step2" class="step bg-white rounded-2xl shadow-lg p-8">
                <h2 class="font-display text-3xl font-bold text-gray-800 mb-2">Seleccione sus Productos</h2>
                <p class="text-gray-600 mb-6">Elija los productos y cantidades deseadas</p>
                
                <div class="space-y-6">
                    <!-- Leche de Cabra -->
                    <div class="product-card rounded-xl p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="flex-1 mb-4 md:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Leche de Cabra Fresca</h3>
                                <p class="text-gray-600 mt-1">Leche 100% natural, sin aditivos ni conservantes</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-2xl font-bold text-green-600">Gs. 25.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1 litro</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="leche" data-action="decrease">-</button>
                                <span id="leche-quantity" class="w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="leche" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Queso de Cabra -->
                    <div class="product-card rounded-xl p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="flex-1 mb-4 md:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Queso de Cabra</h3>
                                <p class="text-gray-600 mt-1">Queso artesanal con sabor suave y textura cremosa</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-2xl font-bold text-blue-600">Gs. 180.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1kg</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="queso" data-action="decrease">-</button>
                                <span id="queso-quantity" class="w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="queso" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yogur de Cabra -->
                    <div class="product-card rounded-xl p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="flex-1 mb-4 md:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Yogur de Cabra Natural</h3>
                                <p class="text-gray-600 mt-1">Yogur elaborado con leche de cabra fresca, sin azúcar añadida</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-2xl font-bold text-purple-600">Gs. 25.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1 litro</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="yogur" data-action="decrease">-</button>
                                <span id="yogur-quantity" class="w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="yogur" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dulce de Leche -->
                    <div class="product-card rounded-xl p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="flex-1 mb-4 md:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Dulce de Leche de Cabra</h3>
                                <p class="text-gray-600 mt-1">Dulce de leche artesanal con sabor único y cremoso</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-2xl font-bold text-yellow-600">Gs. 60.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1Kg</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="dulce" data-action="decrease">-</button>
                                <span id="dulce-quantity" class="w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="dulce" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kit de Degustación -->
                    <div class="product-card rounded-xl p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="flex-1 mb-4 md:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Kit de Degustación</h3>
                                <p class="text-gray-600 mt-1">Incluye: leche, queso, yogur y dulce de leche</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-2xl font-bold text-pink-600">Gs. 60.000</span>
                                    <span class="text-sm text-gray-500 ml-2">Kit completo</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="kit" data-action="decrease">-</button>
                                <span id="kit-quantity" class="w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="kit" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button id="backToStep1" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Volver
                        </button>
                        <button id="nextToStep3" class="btn-primary flex items-center">
                            Continuar a Confirmación <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Paso 3: Confirmación -->
            <div id="step3" class="step bg-white rounded-2xl shadow-lg p-8">
                <h2 class="font-display text-3xl font-bold text-gray-800 mb-2">Confirmación del Pedido</h2>
                <p class="text-gray-600 mb-6">Revise su pedido antes de enviarlo al sistema</p>
                
                <div class="space-y-6">
                    <!-- Información del Cliente -->
                    <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                        <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Información del Cliente</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Nombre</p>
                                <p id="summary-name" class="font-medium text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Teléfono</p>
                                <p id="summary-phone" class="font-medium text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ciudad</p>
                                <p id="summary-city" class="font-medium text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ubicación</p>
                                <p id="summary-location" class="font-medium text-gray-800"></p>
                            </div>
                            <div id="summary-department-container" class="hidden">
                                <p class="text-sm text-gray-600">Departamento</p>
                                <p id="summary-department" class="font-medium text-gray-800"></p>
                            </div>
                            <div id="summary-district-container" class="hidden">
                                <p class="text-sm text-gray-600">Distrito</p>
                                <p id="summary-district" class="font-medium text-gray-800"></p>
                            </div>
                            <div id="summary-payment-container" class="hidden">
                                <p class="text-sm text-gray-600">Método de Pago</p>
                                <p id="summary-payment" class="font-medium text-gray-800"></p>
                            </div>
                            <div id="summary-shipping-container" class="hidden">
                                <p class="text-sm text-gray-600">Agencia de Envío</p>
                                <p id="summary-shipping" class="font-medium text-gray-800"></p>
                            </div>
                        </div>
                        <div class="mt-4" id="summary-location-link-container">
                            <p class="text-sm text-gray-600">Enlace de ubicación:</p>
                            <a id="summary-location-link" href="#" target="_blank" class="location-link text-sm"></a>
                        </div>
                    </div>
                    
                    <!-- Productos Seleccionados -->
                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                        <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Productos Seleccionados</h3>
                        <div id="summary-products" class="space-y-3"></div>
                        <div class="mt-6 pt-4 border-t border-blue-200">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800">Total del Pedido:</span>
                                <span id="summary-total" class="text-2xl font-bold text-green-600">Gs. 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mensajes de estado -->
                    <div id="successMessage" class="success-message hidden">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            <div>
                                <h4 class="font-bold text-green-800">¡Pedido enviado con éxito!</h4>
                                <p class="text-green-700">Su pedido ha sido procesado correctamente. Nos contactaremos pronto.</p>
                            </div>
                        </div>
                    </div>

                    <div id="errorMessage" class="error-message hidden">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                            <div>
                                <h4 class="font-bold text-red-800">Error al enviar el pedido</h4>
                                <p class="text-red-700">Por favor, contacte al <strong>0976 463756</strong> para completar su pedido.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button id="backToStep2" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Volver a Productos
                        </button>
                        <button id="sendOrder" class="btn-primary flex items-center text-lg px-8 py-4">
                            <i class="fas fa-paper-plane mr-2"></i> Confirmar y Enviar Pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-6">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                            <img src="images/Copia de Copia de Copia de Granja Abuelo Felipe (1).png" alt="Logo Granja Abuelo Felipe" class="w-15 h-15 object-contain">
                        </div>
                        <div>
                            <h3 class="font-display text-xl font-bold">GRANJA ABUELO FELIPE</h3>
                            <p class="text-gray-400 text-sm">Leche de Cabra Artesanal</p>
                        </div>
                    </div>
                    <p class="text-gray-300 leading-relaxed">
                        Una tradición familiar dedicada a la producción artesanal de productos lácteos de cabra de la más alta calidad.
                    </p>
                </div>
                
                <div>
                    <h4 class="font-display text-lg font-bold mb-4">Información de Contacto</h4>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <span class="text-green-400">📱</span>
                            <span>0976 463756</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-blue-400">📍</span>
                            <span>Granja Abuelo Felipe - Paraguay</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-yellow-400">🕒</span>
                            <span>Lunes a Sábado: 6:00 - 18:00</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-display text-lg font-bold mb-4">Enlaces Rápidos</h4>
                    <div class="space-y-2">
                        <a href="index.html" class="block text-gray-300 hover:text-green-400 transition-colors">Inicio</a>
                        <a href="index.html#productos" class="block text-gray-300 hover:text-green-400 transition-colors">Productos</a>
                        <a href="nosotros.html" class="block text-gray-300 hover:text-green-400 transition-colors">Nosotros</a>
                        <a href="index.html#contacto" class="block text-gray-300 hover:text-green-400 transition-colors">Contacto</a>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                <p class="text-gray-400">
                    © 2024 Granja Abuelo Felipe. Todos los derechos reservados. | Hecho con ❤️ para nuestra comunidad.
                </p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // CONFIGURACIÓN FIREBASE - TUS DATOS REALES
        const firebaseConfig = {
            apiKey: "AIzaSyBi-UfoiEzwiMRv_9nH9ex_NWm7xVgtbEo",
            authDomain: "granja-abuelo-felipe.firebaseapp.com",
            projectId: "granja-abuelo-felipe",
            storageBucket: "granja-abuelo-felipe.firebasestorage.app",
            messagingSenderId: "164634430679",
            appId: "1:164634430679:web:31bef3f832a6ccda26f492"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Datos de departamentos y distritos de Paraguay
        const paraguayLocations = {
            "Alto Paraguay": ["Fuerte Olimpo", "Mayor Pablo Lagerenza", "Carmelo Peralta"],
            "Alto Paraná": ["Ciudad del Este", "Presidente Franco", "Hernandarias", "Itakyry", "Juan León Mallorquín", "Domingo Martínez de Irala", "Dr. Juan León Mallorquín", "Yguazú", "Dr. Raúl Peña"],
            "Amambay": ["Pedro Juan Caballero", "Bella Vista Norte", "Capitán Bado"],
            "Boquerón": ["Filadelfia", "Loma Plata", "Mariscal Estigarribia"],
            "Caaguazú": ["Coronel Oviedo", "Caaguazú", "Cnel. Oviedo", "Dr. Juan Manuel Frutos", "José Domingo Ocampos", "La Pastora", "Mcal. Francisco Solano López", "Nueva Londres", "Raúl Arsenio Oviedo", "Repatriación", "R.I. 3 Corrales", "San José de los Arroyos", "Santa Rosa del Mbutuy", "Simón Bolívar", "Tres de Febrero", "Vaquería", "Yhú"],
            "Caazapá": ["Caazapá", "Abaí", "Buena Vista", "Dr. Moisés S. Bertoni", "General Higinio Morínigo", "Maciel", "San Juan Nepomuceno", "Tavaí", "3 de Mayo"],
            "Canindeyú": ["Salto del Guairá", "Villa Ygatimí", "Curuguaty", "La Paloma del Espíritu Santo", "Katuetē", "Corpus Christi", "Yby Pytã", "Ypejhú", "Itanará"],
            "Central": ["Asunción", "Areguá", "Capiatá", "Fernando de la Mora", "Guarambaré", "Itá", "Itauguá", "Lambaré", "Limpio", "Luque", "Mariano Roque Alonso", "Ñemby", "Nueva Italia", "San Antonio", "San Lorenzo", "Villa Elisa", "Villeta", "Ypacaraí", "Ypané"],
            "Concepción": ["Concepción", "Azotey", "Belén", "Horqueta", "Loreto", "San Carlos del Apa", "San Lázaro", "Yby Yaú"],
            "Cordillera": ["Caacupé", "Altos", "Arroyos y Esteros", "Atyrá", "Caraguatay", "Emboscada", "Eusebio Ayala", "Isla Pucú", "Itacurubí de la Cordillera", "Juan de Mena", "Loma Grande", "Mbocayaty del Yhaguy", "Nueva Colombia", "Piribebuy", "Primero de Marzo", "San Bernardino", "Santa Elena", "Tobatí", "Valenzuela"],
            "Guairá": ["Villarrica", "Borja", "Capitán Mauricio José Troche", "Coronel Martínez", "Dr. Bottrell", "Félix Pérez Cardozo", "Garay", "General Eugenio Alejandrino Garay", "Independencia", "Itapé", "Iturbe", "José Fassardi", "Mbocayaty del Guairá", "Natalicio Talavera", "Ñumi", "Paso Yobái", "San Salvador", "Yataity"],
            "Itapúa": ["Encarnación", "Bella Vista", "Cambyretá", "Capitán Meza", "Capitán Miranda", "Carlos Antonio López", "Carmen del Paraná", "Coronel Bogado", "Edelira", "Fram", "General Artigas", "General Delgado", "Hohenau", "Jesús", "José Leandro Oviedo", "La Paz", "Leandro N. Alem", "Mayor Otaño", "Natalio", "Nueva Alborada", "Obligado", "Pirapó", "San Cosme y Damián", "San Pedro del Paraná", "San Rafael del Paraná", "Tomás Romero Pereira", "Trinidad", "Yatytay"],
            "Misiones": ["San Juan Bautista", "Ayolas", "San Ignacio", "San Miguel", "San Patricio", "Santa María", "Santa Rosa", "Santiago", "Villa Florida"],
            "Ñeembucú": ["Pilar", "Alberdi", "Cerrito", "Desmochados", "General José Eduvigis Díaz", "Guazú Cuá", "Humaitá", "Isla Umbú", "Laureles", "Mayor José de Jesús Martínez", "Paso de Patria", "San Juan de Ñeembucú", "Tacuaras", "Villa Franca", "Villa Oliva", "Villalbín"],
            "Paraguarí": ["Paraguarí", "Acahay", "Caapucú", "Carapeguá", "Escobar", "General Bernardino Caballero", "La Colmena", "Mbuyapey", "Pirayú", "Quiindy", "Quyquyhó", "San Roque González de Santa Cruz", "Sapucai", "Tebicuary-mí", "Yaguarón", "Ybycuí", "Ybytymí"],
            "Presidente Hayes": ["Villa Hayes", "Benjamín Aceval", "José Falcón", "Nanawa", "Puerto Pinasco", "Teniente Irala Fernández", "Teniente Esteban Martínez", "Vista Alegre"],
            "San Pedro": ["San Pedro de Ycuamandiyú", "Antequera", "Capiibary", "Choré", "General Elizardo Aquino", "General Francisco Isidoro Resquín", "Guayauí", "Itacurubí del Rosario", "Lima", "Nueva Germania", "San Estanislao", "San Pablo", "Santa Rosa del Aguaray", "Tacuatí", "Unión", "Veinticinco de Diciembre", "Villa del Rosario", "Yataity del Norte", "Yrybucuá"]
        };

        // Ciudades principales para mostrar primero
        const mainCities = [
            "Asunción", "Ciudad del Este", "Encarnación", "Coronel Oviedo", 
            "Pedro Juan Caballero", "Concepción", "Villarrica", "Pilar", 
            "Caacupé", "San Juan Bautista", "Paraguarí", "San Pedro de Ycuamandiyú"
        ];

        // Variables globales
        let currentStep = 1;
        let map;
        let marker;
        let selectedLat = -25.4481;
        let selectedLng = -56.4428;
        let selectedAddress = "Centro de Coronel Oviedo";
        let googleMapsLink = "https://maps.google.com/?q=-25.4481,-56.4428";
        let selectedPaymentMethod = '';
        let selectedShippingAgency = '';
        
        const products = {
            leche: { name: "Leche de Cabra Fresca", price: 25000, quantity: 0 },
            queso: { name: "Queso de Cabra", price: 180000, quantity: 0 },
            yogur: { name: "Yogur de Cabra Natural", price: 25000, quantity: 0 },
            dulce: { name: "Dulce de Leche de Cabra", price: 60000, quantity: 0 },
            kit: { name: "Kit de Degustación", price: 60000, quantity: 0 }
        };

        // Elementos del DOM
        const customerCity = document.getElementById('customerCity');
        const customerDepartment = document.getElementById('customerDepartment');
        const customerDistrict = document.getElementById('customerDistrict');
        const locationDetails = document.getElementById('locationDetails');
        const paymentMethodContainer = document.getElementById('paymentMethodContainer');
        const shippingAgencyContainer = document.getElementById('shippingAgencyContainer');
        const otherAgencyContainer = document.getElementById('otherAgencyContainer');
        const shippingAgency = document.getElementById('shippingAgency');
        const otherAgency = document.getElementById('otherAgency');
        const coronelOviedoMap = document.getElementById('coronelOviedoMap');
        const otherCityReference = document.getElementById('otherCityReference');
        const steps = document.querySelectorAll('.step');
        const progressBar = document.getElementById('progress-bar');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // Botones de navegación
        const nextToStep2 = document.getElementById('nextToStep2');
        const nextToStep3 = document.getElementById('nextToStep3');
        const backToStep1 = document.getElementById('backToStep1');
        const backToStep2 = document.getElementById('backToStep2');
        const sendOrder = document.getElementById('sendOrder');
        
        // ==================== INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar select de ciudades
            initializeCitySelect();
            
            // Configurar evento para mostrar/ocultar elementos según ciudad
            customerCity.addEventListener('change', handleCityChange);
            
            // Configurar opciones de pago
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('.bg-green-500').classList.add('hidden');
                    });
                    this.classList.add('selected');
                    this.querySelector('.bg-green-500').classList.remove('hidden');
                    selectedPaymentMethod = this.getAttribute('data-value');
                });
            });
            
            // Configurar agencia de envío
            shippingAgency.addEventListener('change', function() {
                selectedShippingAgency = this.value;
                if (this.value === 'otra') {
                    otherAgencyContainer.classList.remove('hidden');
                } else {
                    otherAgencyContainer.classList.add('hidden');
                }
            });
            
            // Inicializar botones de cantidad
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const product = e.target.closest('.quantity-btn').dataset.product;
                    const action = e.target.closest('.quantity-btn').dataset.action;
                    
                    if (action === 'increase') {
                        products[product].quantity++;
                    } else if (action === 'decrease' && products[product].quantity > 0) {
                        products[product].quantity--;
                    }
                    
                    document.getElementById(`${product}-quantity`).textContent = products[product].quantity;
                });
            });
        });

        // ==================== FUNCIONES DE UBICACIÓN ====================
        function initializeCitySelect() {
            const citySelect = document.getElementById('customerCity');
            citySelect.innerHTML = '<option value="">Seleccione una ciudad</option>';
            
            // Agregar ciudades principales primero
            mainCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
            
            // Agregar separador
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '──────────';
            citySelect.appendChild(separator);
            
            // Agregar todas las demás ciudades
            const allCities = getAllCities();
            allCities.forEach(city => {
                if (!mainCities.includes(city)) {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                }
            });
        }

        function getAllCities() {
            const allCities = new Set();
            
            for (const department in paraguayLocations) {
                paraguayLocations[department].forEach(district => {
                    allCities.add(district);
                });
            }
            
            return Array.from(allCities).sort();
        }

        function findDepartmentForCity(city) {
            for (const department in paraguayLocations) {
                if (paraguayLocations[department].includes(city)) {
                    return department;
                }
            }
            return null;
        }

        function handleCityChange() {
            const city = customerCity.value;
            
            // Ocultar todos los contenedores primero
            locationDetails.classList.add('hidden');
            paymentMethodContainer.classList.add('hidden');
            shippingAgencyContainer.classList.add('hidden');
            otherAgencyContainer.classList.add('hidden');
            coronelOviedoMap.style.display = 'none';
            otherCityReference.classList.add('hidden');
            
            if (city) {
                const department = findDepartmentForCity(city);
                
                if (department) {
                    // Mostrar detalles de ubicación
                    customerDepartment.value = department;
                    
                    // Actualizar distritos según el departamento
                    customerDistrict.innerHTML = '<option value="">Seleccione distrito</option>';
                    paraguayLocations[department].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        if (district === city) {
                            option.selected = true;
                        }
                        customerDistrict.appendChild(option);
                    });
                    
                    locationDetails.classList.remove('hidden');
                }
                
                // Mostrar/ocultar métodos de pago y envío según la ciudad
                if (city === 'Coronel Oviedo') {
                    paymentMethodContainer.classList.remove('hidden');
                    coronelOviedoMap.style.display = 'block';
                    if (!map) {
                        initMap();
                    }
                } else {
                    shippingAgencyContainer.classList.remove('hidden');
                    otherCityReference.classList.remove('hidden');
                }
            }
        }

        // ==================== FUNCIÓN MEJORADA PARA GUARDAR PEDIDO ====================
        async function guardarPedidoFirebase(pedidoData) {
            try {
                const pedidoId = 'PED' + Date.now();
                
                // Recolectar datos adicionales
                const department = customerDepartment.value;
                const district = customerDistrict.value;
                
                let paymentMethod = '';
                let shippingAgency = '';
                
                if (pedidoData.ciudad === 'Coronel Oviedo') {
                    paymentMethod = selectedPaymentMethod;
                } else {
                    shippingAgency = selectedShippingAgency;
                    if (shippingAgency === 'otra') {
                        shippingAgency = otherAgency.value;
                    }
                }
                
                const datosPedido = {
                    id: pedidoId,
                    cliente: pedidoData.nombre,
                    telefono: pedidoData.telefono,
                    ciudad: pedidoData.ciudad,
                    departamento: department,
                    distrito: district,
                    direccion: pedidoData.ciudad + ' - ' + (pedidoData.referencia || ''),
                    productos: pedidoData.productos,
                    total: pedidoData.total,
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    estado: 'pendiente',
                    repartidor: '',
                    metodoPago: paymentMethod,
                    agenciaEnvio: shippingAgency
                };

                // Si es Coronel Oviedo y hay datos del mapa, agregar coordenadas exactas
                if (pedidoData.ciudad === 'Coronel Oviedo' && map) {
                    datosPedido.direccion += ' | ' + selectedAddress;
                    datosPedido.coordenadas = {
                        lat: parseFloat(selectedLat),
                        lng: parseFloat(selectedLng)
                    };
                    datosPedido.mapa = googleMapsLink;
                }

                await db.collection('pedidos').doc(pedidoId).set(datosPedido);
                
                console.log('✅ Pedido guardado en Firebase:', pedidoId);
                return true;
                
            } catch (error) {
                console.error('❌ Error Firebase:', error);
                return false;
            }
        }

        // ==================== FUNCIÓN PRINCIPAL ====================
        async function enviarPedidoSistema() {
            if (!validateStep3()) {
                return false;
            }
            
            const pedidoData = {
                nombre: document.getElementById('customerName').value,
                telefono: document.getElementById('customerPhone').value,
                ciudad: customerCity.value,
                referencia: '',
                productos: [],
                total: 0,
                fecha: new Date().toLocaleString('es-PY')
            };

            // Obtener referencia según la ciudad
            if (pedidoData.ciudad === 'Coronel Oviedo') {
                pedidoData.referencia = document.getElementById('locationReference')?.value || '';
            } else {
                pedidoData.referencia = document.getElementById('locationReferenceOther')?.value || '';
            }

            // Obtener productos seleccionados
            let tieneProductos = false;
            for (const product in products) {
                if (products[product].quantity > 0) {
                    tieneProductos = true;
                    const subtotal = products[product].quantity * products[product].price;
                    pedidoData.total += subtotal;
                    pedidoData.productos.push({
                        nombre: products[product].name,
                        cantidad: products[product].quantity,
                        precio: products[product].price
                    });
                }
            }
            
            if (!tieneProductos) {
                alert('❌ Por favor selecciona al menos un producto');
                return false;
            }

            // Mostrar loading
            mostrarLoading();
            
            try {
                console.log('Enviando pedido a Firebase...');
                
                const success = await guardarPedidoFirebase(pedidoData);
                
                if (success) {
                    mostrarExito();
                } else {
                    mostrarError();
                }
                
                return success;
                
            } catch (error) {
                console.error('Error general:', error);
                mostrarError();
                return false;
            } finally {
                ocultarLoading();
            }
        }

        // ==================== FUNCIONES DE INTERFAZ ====================
        function mostrarLoading() {
            loadingOverlay.style.display = 'flex';
            sendOrder.disabled = true;
            sendOrder.innerHTML = '⏳ Enviando pedido...';
        }

        function ocultarLoading() {
            loadingOverlay.style.display = 'none';
            sendOrder.disabled = false;
            sendOrder.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Confirmar y Enviar Pedido';
        }

        function mostrarExito() {
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            sendOrder.disabled = true;
            sendOrder.innerHTML = '<i class="fas fa-check mr-2"></i> Pedido Enviado';
            sendOrder.classList.remove('btn-primary');
            sendOrder.classList.add('bg-gray-400', 'cursor-not-allowed');
            
            // Redirigir después de 5 segundos
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 5000);
        }

        function mostrarError() {
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        // ==================== MAPA MEJORADO ====================
        function initMap() {
            const oviedoCenter = [selectedLat, selectedLng];
            
            map = L.map('interactive-map').setView(oviedoCenter, 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Crear marcador inicial
            marker = L.marker(oviedoCenter, {
                draggable: true,
                icon: L.divIcon({
                    className: 'custom-marker',
                    iconSize: [20, 20]
                })
            }).addTo(map);
            
            // ZONAS PREDEFINIDAS DE CORONEL OVIEDO
            const zonasCoronelOviedo = [
                { coords: [-25.4481, -56.4428], nombre: 'Centro - Plaza Principal' },
                { coords: [-25.4410, -56.4400], nombre: 'Barrio San Miguel' },
                { coords: [-25.4550, -56.4350], nombre: 'Barrio Santa Teresa' },
                { coords: [-25.4380, -56.4500], nombre: 'Barrio San Antonio' },
                { coords: [-25.4600, -56.4300], nombre: 'Barrio San Roque' },
                { coords: [-25.4350, -56.4250], nombre: 'Barrio San Blas' },
                { coords: [-25.4300, -56.4550], nombre: 'Barrio San Pablo' },
                { coords: [-25.4650, -56.4450], nombre: 'Barrio San José' },
                { coords: [-25.4420, -56.4250], nombre: 'Barrio Santa Lucía' },
                { coords: [-25.4500, -56.4550], nombre: 'Barrio Virgen del Rosario' },
                { coords: [-25.4250, -56.4400], nombre: 'Barrio San Rafael' },
                { coords: [-25.4700, -56.4350], nombre: 'Barrio San Juan' }
            ];
            
            // Función para encontrar zona más cercana
            function encontrarZonaCercana(lat, lng) {
                let zonaMasCercana = 'Ubicación en Coronel Oviedo';
                let distanciaMinima = 0.02;
                
                for (const zona of zonasCoronelOviedo) {
                    const distancia = Math.sqrt(
                        Math.pow(lat - zona.coords[0], 2) + 
                        Math.pow(lng - zona.coords[1], 2)
                    );
                    
                    if (distancia < distanciaMinima) {
                        distanciaMinima = distancia;
                        zonaMasCercana = zona.nombre;
                    }
                }
                
                return zonaMasCercana;
            }
            
            // Función para actualizar ubicación
            function actualizarUbicacion(lat, lng) {
                selectedLat = lat.toFixed(6);
                selectedLng = lng.toFixed(6);
                googleMapsLink = `https://maps.google.com/?q=${selectedLat},${selectedLng}`;
                
                // Encontrar zona más cercana
                const zona = encontrarZonaCercana(lat, lng);
                selectedAddress = `${zona}`;
                
                updateLocationDisplay();
            }
            
            // Evento para actualizar ubicación al arrastrar
            marker.on('dragend', function(e) {
                const position = marker.getLatLng();
                actualizarUbicacion(position.lat, position.lng);
            });
            
            // Evento para actualizar ubicación al hacer clic
            map.on('click', function(e) {
                const position = e.latlng;
                actualizarUbicacion(position.lat, position.lng);
                marker.setLatLng(position);
            });
            
            updateLocationDisplay();
        }

        function updateLocationDisplay() {
            document.getElementById('selected-lat').textContent = selectedLat;
            document.getElementById('selected-lng').textContent = selectedLng;
            document.getElementById('location-link').textContent = googleMapsLink;
            document.getElementById('location-link').href = googleMapsLink;
            document.getElementById('selected-address').textContent = selectedAddress;
        }

        // ==================== SISTEMA DE PASOS ====================
        function changeStep(step) {
            steps.forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }

        function updateProgressBar(percentage) {
            progressBar.style.width = `${percentage}%`;
        }

        function validateStep1() {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const city = customerCity.value;
            const department = customerDepartment.value;
            const district = customerDistrict.value;
            
            if (!name || !phone || !city || !department || !district) {
                alert('❌ Por favor, complete todos los campos obligatorios.');
                return false;
            }
            
            // Validar formato de teléfono paraguayo
            const phoneRegex = /^(595|0)?9[0-9]{8}$/;
            const cleanPhone = phone.replace(/\s+/g, '').replace('+', '').replace('-', '');
            
            if (!phoneRegex.test(cleanPhone)) {
                alert('❌ Por favor ingresa un número de WhatsApp válido de Paraguay (ej: 0981123456)');
                return false;
            }
            
            // Validar método de pago para Coronel Oviedo
            if (city === 'Coronel Oviedo') {
                if (!selectedPaymentMethod) {
                    alert('❌ Por favor seleccione un método de pago.');
                    return false;
                }
            }
            
            // Validar agencia de envío para otras ciudades
            if (city !== 'Coronel Oviedo') {
                if (!selectedShippingAgency) {
                    alert('❌ Por favor seleccione una agencia de envío.');
                    return false;
                }
                
                if (selectedShippingAgency === 'otra' && !otherAgency.value) {
                    alert('❌ Por favor especifique la agencia de envío.');
                    return false;
                }
                
                // Validar referencia para otras ciudades
                const referencia = document.getElementById('locationReferenceOther').value;
                if (!referencia) {
                    alert('❌ Por favor, ingrese una dirección o referencia para la entrega.');
                    return false;
                }
            }
            
            return true;
        }

        function validateStep2() {
            let hasProducts = false;
            for (const product in products) {
                if (products[product].quantity > 0) {
                    hasProducts = true;
                    break;
                }
            }
            
            if (!hasProducts) {
                alert('❌ Por favor, seleccione al menos un producto.');
                return false;
            }
            
            return true;
        }

        function validateStep3() {
            return validateStep1() && validateStep2();
        }

        // ==================== RESUMEN DEL PEDIDO ====================
        function updateOrderSummary() {
            document.getElementById('summary-name').textContent = document.getElementById('customerName').value;
            document.getElementById('summary-phone').textContent = document.getElementById('customerPhone').value;
            document.getElementById('summary-city').textContent = customerCity.value;
            document.getElementById('summary-department').textContent = customerDepartment.value;
            document.getElementById('summary-district').textContent = customerDistrict.value;
            
            // Actualizar ubicación en el resumen
            const city = customerCity.value;
            let locationText = '';
            let locationLink = '';
            
            if (city === 'Coronel Oviedo') {
                locationText = selectedAddress;
                locationLink = googleMapsLink;
                document.getElementById('summary-location-link-container').classList.remove('hidden');
                document.getElementById('summary-location-link').href = locationLink;
                document.getElementById('summary-location-link').textContent = locationLink;
                document.getElementById('summary-payment-container').classList.remove('hidden');
                document.getElementById('summary-payment').textContent = selectedPaymentMethod === 'efectivo' ? '💵 Efectivo al recibir' : '🏦 Transferencia bancaria';
                document.getElementById('summary-shipping-container').classList.add('hidden');
            } else {
                locationText = document.getElementById('locationReferenceOther').value;
                document.getElementById('summary-location-link-container').classList.add('hidden');
                document.getElementById('summary-payment-container').classList.add('hidden');
                document.getElementById('summary-shipping-container').classList.remove('hidden');
                let shippingText = selectedShippingAgency;
                if (selectedShippingAgency === 'otra') {
                    shippingText = otherAgency.value;
                }
                document.getElementById('summary-shipping').textContent = shippingText;
            }
            
            document.getElementById('summary-location').textContent = locationText;
            document.getElementById('summary-department-container').classList.remove('hidden');
            document.getElementById('summary-district-container').classList.remove('hidden');
            
            const productsSummary = document.getElementById('summary-products');
            productsSummary.innerHTML = '';
            
            let total = 0;
            for (const product in products) {
                if (products[product].quantity > 0) {
                    const productTotal = products[product].quantity * products[product].price;
                    total += productTotal;
                    
                    const productElement = document.createElement('div');
                    productElement.className = 'flex justify-between items-center py-2 border-b border-blue-100';
                    productElement.innerHTML = `
                        <span class="text-gray-700">${products[product].name} x${products[product].quantity}</span>
                        <span class="font-bold text-gray-800">Gs. ${productTotal.toLocaleString()}</span>
                    `;
                    productsSummary.appendChild(productElement);
                }
            }
            
            document.getElementById('summary-total').textContent = `Gs. ${total.toLocaleString()}`;
        }

        // ==================== EVENT LISTENERS ====================
        nextToStep2.addEventListener('click', () => {
            if (validateStep1()) {
                changeStep(2);
                updateProgressBar(66);
            }
        });

        nextToStep3.addEventListener('click', () => {
            if (validateStep2()) {
                updateOrderSummary();
                changeStep(3);
                updateProgressBar(100);
            }
        });

        backToStep1.addEventListener('click', () => {
            changeStep(1);
            updateProgressBar(33);
        });

        backToStep2.addEventListener('click', () => {
            changeStep(2);
            updateProgressBar(66);
        });

        // Botón de enviar pedido
        sendOrder.addEventListener('click', async (e) => {
            e.preventDefault();
            await enviarPedidoSistema();
        });
    </script>
</body>
</html>
