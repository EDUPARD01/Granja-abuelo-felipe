<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Pedido - GRANJA ABUELO FELIPE</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-green: #10b981;
            --primary-blue: #3b82f6;
            --bg-light: #f9fafb;
        }
        
        .font-display { font-family: 'Playfair Display', serif; }
        .font-body { font-family: 'Inter', sans-serif; }
        
        /* Enhanced navigation */
        nav a {
            position: relative;
            transition: all 0.3s ease;
        }

        nav a::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-blue));
            transition: width 0.3s ease;
        }

        nav a:hover::after {
            width: 100%;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-blue), var(--primary-blue));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-green), var(--primary-green));
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .map-container {
            display: none;
            margin-top: 1rem;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .product-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .quantity-btn {
            transition: all 0.2s ease;
            border-radius: 50%;
        }
        .quantity-btn:hover {
            background-color: #d1d5db;
            transform: scale(1.1);
        }
        #interactive-map {
            height: 300px;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1;
        }
        .map-instructions {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .location-coordinates {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .custom-marker {
            background: #dc2626;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-message {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .payment-option {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
        }
        .payment-option.selected {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .shipping-option {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
        }
        .shipping-option.selected {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        .section-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="font-body bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="bg-white rounded-lg p-6 lg:p-8 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg font-semibold text-gray-800">Procesando pedido...</p>
            <p class="text-gray-600">Por favor espere un momento</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="container mx-auto px-4 lg:px-6 py-3 lg:py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2 lg:space-x-3">
                    <a href="index.html" class="flex items-center">
                        <div class="w-10 h-10 lg:w-12 lg:h-12 flex items-center justify-center">
                            <img src="images/Copia de Copia de Copia de Granja Abuelo Felipe (1).png" alt="Logo Granja Abuelo Felipe" class="w-full h-full object-contain">
                        </div>
                    </a>
                    <div>
                        <p class="font-display text-xl lg:text-2xl font-bold text-gray-800">GRANJA ABUELO FELIPE</p>
                        <p class="text-xs lg:text-sm text-gray-600">Leche de Cabra Artesanal</p>
                    </div>
                </div>
               <nav class="hidden lg:flex space-x-6">
    <a href="/" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Inicio</a>
    <a href="#productos" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Productos</a>
    <a href="/nosotros.html" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Nosotros</a>
    <a href="#contacto" class="text-gray-700 hover:text-green-600 font-medium transition-colors">Contacto</a>
</nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20 lg:pt-24 pb-12 lg:pb-16">
        <div class="container mx-auto px-4 lg:px-6 max-w-4xl">
            <!-- Progress Bar -->
            <div class="mb-6 lg:mb-8">
                <div class="flex justify-between mb-2">
                    <span id="step1-label" class="text-sm font-medium text-green-600">Información Personal</span>
                    <span id="step2-label" class="text-sm font-medium text-gray-500">Productos</span>
                    <span id="step3-label" class="text-sm font-medium text-gray-500">Confirmación</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 33%"></div>
                </div>
            </div>

            <!-- Paso 1: Información Personal -->
            <div id="step1" class="step active section-card p-4 lg:p-8">
                <h2 class="font-display text-2xl lg:text-3xl font-bold text-gray-800 mb-2">Información del Pedido</h2>
                <p class="text-gray-600 mb-4 lg:mb-6">Complete sus datos para procesar su pedido</p>
                
                <div class="space-y-4 lg:space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" id="customerName" class="w-full p-3 lg:p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Ingrese su nombre completo" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Número de Teléfono *</label>
                        <input type="tel" id="customerPhone" class="w-full p-3 lg:p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Ej: 0981 123456" required>
                    </div>
                    
                    <!-- Departamento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Departamento *</label>
                        <select id="customerDepartment" class="w-full p-3 lg:p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" required>
                            <option value="">Seleccione un departamento</option>
                        </select>
                    </div>
                    
                    <!-- Distrito -->
                    <div id="districtContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Distrito *</label>
                        <select id="customerDistrict" class="w-full p-3 lg:p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" required>
                            <option value="">Seleccione distrito</option>
                        </select>
                    </div>

                    <!-- Método de Pago -->
                    <div id="paymentMethodContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pago *</label>
                        <div class="space-y-3">
                            <div class="payment-option rounded-lg p-3 lg:p-4 cursor-pointer" data-value="efectivo">
                                <div class="flex items-center space-x-3">
                                    <div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full hidden"></div>
                                    </div>
                                    <span class="text-base lg:text-lg">💵 Efectivo al recibir</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-8 mt-1">Pague cuando reciba su pedido</p>
                            </div>
                            <div class="payment-option rounded-lg p-3 lg:p-4 cursor-pointer" data-value="transferencia">
                                <div class="flex items-center space-x-3">
                                    <div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full hidden"></div>
                                    </div>
                                    <span class="text-base lg:text-lg">🏦 Transferencia bancaria</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-8 mt-1">Realice la transferencia antes de la entrega</p>
                            </div>
                        </div>
                    </div>

                    <!-- Agencia de Envío -->
                    <div id="shippingAgencyContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Agencia de Envío *</label>
                        <select id="shippingAgency" class="w-full p-3 lg:p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                            <option value="">Seleccione agencia de envío</option>
                            <option value="tcd">🚚 TCD Envíos</option>
                            <option value="las-golondrinas">🚛 Las Golondrinas</option>
                            <option value="trans-cit">🚛 Trans Cit</option>
                            <option value="express">🚀 Express Paraguay</option>
                            <option value="otra">🏪 Otra agencia</option>
                        </select>
                    </div>

                    <!-- Campo para otra agencia -->
                    <div id="otherAgencyContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Especifique la agencia *</label>
                        <input type="text" id="otherAgency" class="w-full p-3 lg:p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Nombre de la agencia de envío">
                    </div>
                    
                    <!-- Mapa Interactivo para Coronel Oviedo -->
                    <div id="coronelOviedoMap" class="map-container">
                        <h4 class="font-medium text-gray-700 mb-3">Seleccione su ubicación exacta en Coronel Oviedo</h4>
                        
                        <div class="map-instructions">
                            <div class="flex items-start space-x-2">
                                <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                                <p class="text-sm text-gray-700">
                                    <strong>Instrucciones:</strong> Haga clic en el mapa para colocar el marcador en su ubicación exacta. 
                                    Puede acercar/alejar y mover el mapa para encontrar su dirección precisa.
                                </p>
                            </div>
                        </div>
                        
                        <div id="interactive-map"></div>
                        
                        <div class="location-coordinates">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-map-marker-alt text-red-500"></i>
                                <span class="font-medium">Ubicación seleccionada:</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Latitud:</span>
                                    <span id="selected-lat" class="font-mono">-25.4481</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Longitud:</span>
                                    <span id="selected-lng" class="font-mono">-56.4428</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <span class="text-gray-600">Dirección aproximada:</span>
                                <span id="selected-address" class="font-medium">Centro de Coronel Oviedo</span>
                            </div>
                            <div class="mt-2" id="location-link-container">
                                <span class="text-gray-600">Enlace de ubicación:</span>
                                <a id="location-link" href="#" target="_blank" class="location-link text-sm">
                                    https://maps.google.com/?q=-25.4481,-56.4428
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dirección/Referencia SOLO para Coronel Oviedo -->
                    <div id="coronelOviedoReference" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dirección/Referencia *</label>
                        <textarea id="locationReference" rows="3" class="w-full p-3 lg:p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Ej: Casa color azul, portón negro, a 2 cuadras del supermercado..." required></textarea>
                    </div>
                    
                    <div class="flex justify-end mt-6 lg:mt-8">
                        <button id="nextToStep2" class="btn-primary flex items-center text-sm lg:text-base">
                            Continuar a Productos <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Paso 2: Productos -->
            <div id="step2" class="step section-card p-4 lg:p-8">
                <h2 class="font-display text-2xl lg:text-3xl font-bold text-gray-800 mb-2">Seleccione sus Productos</h2>
                <p class="text-gray-600 mb-4 lg:mb-6">Elija los productos y cantidades deseadas</p>
                
                <div class="space-y-4 lg:space-y-6">
                    <!-- Leche de Cabra -->
                    <div class="product-card rounded-xl p-4 lg:p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between">
                            <div class="flex-1 mb-4 lg:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Leche de Cabra Fresca</h3>
                                <p class="text-gray-600 mt-1 text-sm lg:text-base">Leche 100% natural, sin aditivos ni conservantes</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-xl lg:text-2xl font-bold text-green-600">Gs. 25.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1 litro</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 lg:space-x-4">
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="leche" data-action="decrease">-</button>
                                <span id="leche-quantity" class="w-10 lg:w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="leche" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Queso de Cabra -->
                    <div class="product-card rounded-xl p-4 lg:p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between">
                            <div class="flex-1 mb-4 lg:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Queso de Cabra</h3>
                                <p class="text-gray-600 mt-1 text-sm lg:text-base">Queso artesanal con sabor suave y textura cremosa</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-xl lg:text-2xl font-bold text-blue-600">Gs. 180.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1kg</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 lg:space-x-4">
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="queso" data-action="decrease">-</button>
                                <span id="queso-quantity" class="w-10 lg:w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="queso" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yogur de Cabra -->
                    <div class="product-card rounded-xl p-4 lg:p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between">
                            <div class="flex-1 mb-4 lg:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Yogur de Cabra Natural</h3>
                                <p class="text-gray-600 mt-1 text-sm lg:text-base">Yogur elaborado con leche de cabra fresca, sin azúcar añadida</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-xl lg:text-2xl font-bold text-purple-600">Gs. 25.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1 litro</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 lg:space-x-4">
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="yogur" data-action="decrease">-</button>
                                <span id="yogur-quantity" class="w-10 lg:w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="yogur" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dulce de Leche -->
                    <div class="product-card rounded-xl p-4 lg:p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between">
                            <div class="flex-1 mb-4 lg:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Dulce de Leche de Cabra</h3>
                                <p class="text-gray-600 mt-1 text-sm lg:text-base">Dulce de leche artesanal con sabor único y cremoso</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-xl lg:text-2xl font-bold text-yellow-600">Gs. 60.000</span>
                                    <span class="text-sm text-gray-500 ml-2">1Kg</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 lg:space-x-4">
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="dulce" data-action="decrease">-</button>
                                <span id="dulce-quantity" class="w-10 lg:w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="dulce" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kit de Degustación -->
                    <div class="product-card rounded-xl p-4 lg:p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between">
                            <div class="flex-1 mb-4 lg:mb-0">
                                <h3 class="font-display text-xl font-bold text-gray-800">Kit de Degustación</h3>
                                <p class="text-gray-600 mt-1 text-sm lg:text-base">Incluye: leche, queso, yogur y dulce de leche</p>
                                <div class="flex items-center mt-3">
                                    <span class="text-xl lg:text-2xl font-bold text-pink-600">Gs. 60.000</span>
                                    <span class="text-sm text-gray-500 ml-2">Kit completo</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 lg:space-x-4">
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="kit" data-action="decrease">-</button>
                                <span id="kit-quantity" class="w-10 lg:w-12 text-center text-xl font-bold">0</span>
                                <button class="quantity-btn bg-gray-200 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg font-bold" data-product="kit" data-action="increase">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-6 lg:mt-8">
                        <button id="backToStep1" class="btn-secondary flex items-center text-sm lg:text-base">
                            <i class="fas fa-arrow-left mr-2"></i> Volver
                        </button>
                        <button id="nextToStep3" class="btn-primary flex items-center text-sm lg:text-base">
                            Continuar a Confirmación <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Paso 3: Confirmación -->
            <div id="step3" class="step section-card p-4 lg:p-8">
                <h2 class="font-display text-2xl lg:text-3xl font-bold text-gray-800 mb-2">Confirmación del Pedido</h2>
                <p class="text-gray-600 mb-4 lg:mb-6">Revise su pedido antes de enviarlo al sistema</p>
                
                <div class="space-y-4 lg:space-y-6">
                    <!-- Información del Cliente -->
                    <div class="bg-green-50 p-4 lg:p-6 rounded-xl border border-green-200">
                        <h3 class="font-display text-xl font-bold text-gray-800 mb-3 lg:mb-4">Información del Cliente</h3>
                        <div class="grid md:grid-cols-2 gap-3 lg:gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Nombre</p>
                                <p id="summary-name" class="font-medium text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Teléfono</p>
                                <p id="summary-phone" class="font-medium text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Departamento</p>
                                <p id="summary-department" class="font-medium text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Distrito</p>
                                <p id="summary-district" class="font-medium text-gray-800"></p>
                            </div>
                            <div id="summary-payment-container" class="hidden">
                                <p class="text-sm text-gray-600">Método de Pago</p>
                                <p id="summary-payment" class="font-medium text-gray-800"></p>
                            </div>
                            <div id="summary-shipping-container" class="hidden">
                                <p class="text-sm text-gray-600">Agencia de Envío</p>
                                <p id="summary-shipping" class="font-medium text-gray-800"></p>
                            </div>
                        </div>
                        <div class="mt-3 lg:mt-4">
                            <p class="text-sm text-gray-600">Información de Entrega</p>
                            <p id="summary-location" class="font-medium text-gray-800"></p>
                        </div>
                        <div class="mt-3 lg:mt-4" id="summary-location-link-container">
                            <p class="text-sm text-gray-600">Enlace de ubicación:</p>
                            <a id="summary-location-link" href="#" target="_blank" class="location-link text-sm"></a>
                        </div>
                    </div>
                    
                    <!-- Productos Seleccionados -->
                    <div class="bg-blue-50 p-4 lg:p-6 rounded-xl border border-blue-200">
                        <h3 class="font-display text-xl font-bold text-gray-800 mb-3 lg:mb-4">Productos Seleccionados</h3>
                        <div id="summary-products" class="space-y-2 lg:space-y-3"></div>
                        <div class="mt-4 lg:mt-6 pt-3 lg:pt-4 border-t border-blue-200">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800">Total del Pedido:</span>
                                <span id="summary-total" class="text-xl lg:text-2xl font-bold text-green-600">Gs. 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje de Advertencia -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 lg:p-6">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-lg lg:text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-yellow-800 text-base lg:text-lg mb-2"> Importante: Cancelación de Pedidos</h4>
                                <p class="text-yellow-700 mb-3 text-sm lg:text-base">
                                    En caso de que desee cancelar o modificar su pedido, por favor póngase en contacto por WhatsApp a los siguientes números:
                                </p>
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <a href="https://wa.me/595975308118" 
                                           target="_blank" 
                                           class="bg-green-500 hover:bg-green-600 text-white px-3 lg:px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 text-sm lg:text-base">
                                            <i class="fab fa-whatsapp"></i>
                                            <span>Rocio Barrera</span>
                                        </a>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <a href="https://wa.me/595975318433" 
                                           target="_blank" 
                                           class="bg-green-500 hover:bg-green-600 text-white px-3 lg:px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 text-sm lg:text-base">
                                            <i class="fab fa-whatsapp"></i>
                                            <span>Ronaldo Adorno</span>
                                        </a>
                                    </div>
                                </div>
                                <p class="text-yellow-600 text-xs lg:text-sm mt-3">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Una vez enviado el pedido, tendrá un tiempo limitado para realizar cancelaciones.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Mensajes de estado -->
                    <div id="successMessage" class="success-message hidden">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-check-circle text-green-500 text-lg lg:text-xl"></i>
                            <div>
                                <h4 class="font-bold text-green-800">¡Pedido enviado con éxito!</h4>
                                <p class="text-green-700">Su pedido ha sido procesado correctamente. Nos contactaremos pronto.</p>
                            </div>
                        </div>
                    </div>

                    <div id="errorMessage" class="error-message hidden">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-exclamation-triangle text-red-500 text-lg lg:text-xl"></i>
                            <div>
                                <h4 class="font-bold text-red-800">Error al enviar el pedido</h4>
                                <p class="text-red-700">Por favor, contacte al <strong>0976 463756</strong> para completar su pedido.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-6 lg:mt-8">
                        <button id="backToStep2" class="btn-secondary flex items-center text-sm lg:text-base">
                            <i class="fas fa-arrow-left mr-2"></i> Volver a Productos
                        </button>
                        <button id="sendOrder" class="btn-primary flex items-center text-sm lg:text-base px-6 lg:px-8 py-3 lg:py-4">
                            <i class="fas fa-paper-plane mr-2"></i> Confirmar y Enviar Pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 lg:py-12">
        <div class="container mx-auto px-4 lg:px-6">
            <div class="grid lg:grid-cols-3 gap-6 lg:gap-8">
                <div>
                    <div class="flex items-center space-x-2 lg:space-x-3 mb-3 lg:mb-4">
                        <a href="index.html" class="flex items-center">
                            <div class="w-10 h-10 lg:w-12 lg:h-12 flex items-center justify-center">
                                <img src="images/Copia de Copia de Copia de Granja Abuelo Felipe (1).png" alt="Logo Granja Abuelo Felipe" class="w-full h-full object-contain">
                            </div>
                        </a>
                        <div>
                            <h3 class="font-display text-lg lg:text-xl font-bold">GRANJA ABUELO FELIPE</h3>
                            <p class="text-xs lg:text-sm text-gray-400">Leche de Cabra Artesanal</p>
                        </div>
                    </div>
                    <p class="text-xs lg:text-sm text-gray-300 leading-relaxed">
                        Una tradición familiar dedicada a la producción artesanal de productos lácteos de cabra de la más alta calidad.
                    </p>
                </div>
                
                <div>
                    <h4 class="font-display text-base lg:text-lg font-bold mb-3 lg:mb-4">Información de Contacto</h4>
                    <div class="space-y-2 lg:space-y-3">
                        <div class="flex items-center space-x-2 lg:space-x-3">
                            <span class="text-green-400">📱</span>
                            <span class="text-xs lg:text-sm">0975 318433</span>
                        </div>
                        <div class="flex items-center space-x-2 lg:space-x-3">
                            <span class="text-green-400">📱</span>
                            <span class="text-xs lg:text-sm">0975 308118</span>
                        </div>
                        <div class="flex items-center space-x-2 lg:space-x-3">
                            <span class="text-blue-400">📍</span>
                            <span class="text-xs lg:text-sm">Granja Abuelo Felipe - Paraguay</span>
                        </div>
                        <div class="flex items-center space-x-2 lg:space-x-3">
                            <span class="text-yellow-400">🕒</span>
                            <span class="text-xs lg:text-sm">Lunes a Sábado: 6:00 - 18:00</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-display text-base lg:text-lg font-bold mb-3 lg:mb-4">Enlaces Rápidos</h4>
                    <div class="space-y-1 lg:space-y-2">
                        <a href="index.html" class="block text-xs lg:text-sm text-gray-300 hover:text-green-400 transition-colors">Inicio</a>
                        <a href="index.html#productos" class="block text-xs lg:text-sm text-gray-300 hover:text-green-400 transition-colors">Productos</a>
                        <a href="nosotros.html" class="block text-xs lg:text-sm text-gray-300 hover:text-green-400 transition-colors">Nosotros</a>
                        <a href="index.html#contacto" class="block text-xs lg:text-sm text-gray-300 hover:text-green-400 transition-colors">Contacto</a>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-6 lg:mt-8 pt-6 lg:pt-8 text-center">
                <p class="text-xs lg:text-sm text-gray-400">
                    © 2024 Granja Abuelo Felipe. Todos los derechos reservados. | Hecho con ❤️ para nuestra comunidad.
                </p>
            </div>
        </div>
    </footer>

     <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // CONFIGURACIÓN FIREBASE - TUS DATOS REALES
        const firebaseConfig = {
            apiKey: "AIzaSyBi-UfoiEzwiMRv_9nH9ex_NWm7xVgtbEo",
            authDomain: "granja-abuelo-felipe.firebaseapp.com",
            projectId: "granja-abuelo-felipe",
            storageBucket: "granja-abuelo-felipe.firebasestorage.app",
            messagingSenderId: "164634430679",
            appId: "1:164634430679:web:31bef3f832a6ccda26f492"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Datos de departamentos y distritos de Paraguay
        const paraguayLocations = {
            "Alto Paraguay": ["Fuerte Olimpo", "Mayor Pablo Lagerenza", "Carmelo Peralta"],
            "Alto Paraná": ["Ciudad del Este", "Presidente Franco", "Hernandarias", "Itakyry", "Juan León Mallorquín", "Domingo Martínez de Irala", "Dr. Juan León Mallorquín", "Yguazú", "Dr. Raúl Peña"],
            "Amambay": ["Pedro Juan Caballero", "Bella Vista Norte", "Capitán Bado"],
            "Boquerón": ["Filadelfia", "Loma Plata", "Mariscal Estigarribia"],
            "Caaguazú": ["Caaguazú", "Cnel. Oviedo", "Dr. Juan Manuel Frutos", "José Domingo Ocampos", "La Pastora", "Mcal. Francisco Solano López", "Nueva Londres", "Raúl Arsenio Oviedo", "Repatriación", "R.I. 3 Corrales", "San José de los Arroyos", "Santa Rosa del Mbutuy", "Simón Bolívar", "Tres de Febrero", "Vaquería", "Yhú"],
            "Caazapá": ["Caazapá", "Abaí", "Buena Vista", "Dr. Moisés S. Bertoni", "General Higinio Morínigo", "Maciel", "San Juan Nepomuceno", "Tavaí", "3 de Mayo"],
            "Canindeyú": ["Salto del Guairá", "Villa Ygatimí", "Curuguaty", "La Paloma del Espíritu Santo", "Katuetē", "Corpus Christi", "Yby Pytã", "Ypejhú", "Itanará"],
            "Central": ["Asunción", "Areguá", "Capiatá", "Fernando de la Mora", "Guarambaré", "Itá", "Itauguá", "Lambaré", "Limpio", "Luque", "Mariano Roque Alonso", "Ñemby", "Nueva Italia", "San Antonio", "San Lorenzo", "Villa Elisa", "Villeta", "Ypacaraí", "Ypané"],
            "Concepción": ["Concepción", "Azotey", "Belén", "Horqueta", "Loreto", "San Carlos del Apa", "San Lázaro", "Yby Yaú"],
            "Cordillera": ["Caacupé", "Altos", "Arroyos y Esteros", "Atyrá", "Caraguatay", "Emboscada", "Eusebio Ayala", "Isla Pucú", "Itacurubí de la Cordillera", "Juan de Mena", "Loma Grande", "Mbocayaty del Yhaguy", "Nueva Colombia", "Piribebuy", "Primero de Marzo", "San Bernardino", "Santa Elena", "Tobatí", "Valenzuela"],
            "Guairá": ["Villarrica", "Borja", "Capitán Mauricio José Troche", "Coronel Martínez", "Dr. Bottrell", "Félix Pérez Cardozo", "Garay", "General Eugenio Alejandrino Garay", "Independencia", "Itapé", "Iturbe", "José Fassardi", "Mbocayaty del Guairá", "Natalicio Talavera", "Ñumi", "Paso Yobái", "San Salvador", "Yataity"],
            "Itapúa": ["Encarnación", "Bella Vista", "Cambyretá", "Capitán Meza", "Capitán Miranda", "Carlos Antonio López", "Carmen del Paraná", "Coronel Bogado", "Edelira", "Fram", "General Artigas", "General Delgado", "Hohenau", "Jesús", "José Leandro Oviedo", "La Paz", "Leandro N. Alem", "Mayor Otaño", "Natalio", "Nueva Alborada", "Obligado", "Pirapó", "San Cosme y Damián", "San Pedro del Paraná", "San Rafael del Paraná", "Tomás Romero Pereira", "Trinidad", "Yatytay"],
            "Misiones": ["San Juan Bautista", "Ayolas", "San Ignacio", "San Miguel", "San Patricio", "Santa María", "Santa Rosa", "Santiago", "Villa Florida"],
            "Ñeembucú": ["Pilar", "Alberdi", "Cerrito", "Desmochados", "General José Eduvigis Díaz", "Guazú Cuá", "Humaitá", "Isla Umbú", "Laureles", "Mayor José de Jesús Martínez", "Paso de Patria", "San Juan de Ñeembucú", "Tacuaras", "Villa Franca", "Villa Oliva", "Villalbín"],
            "Paraguarí": ["Paraguarí", "Acahay", "Caapucú", "Carapeguá", "Escobar", "General Bernardino Caballero", "La Colmena", "Mbuyapey", "Pirayú", "Quiindy", "Quyquyhó", "San Roque González de Santa Cruz", "Sapucai", "Tebicuary-mí", "Yaguarón", "Ybycuí", "Ybytymí"],
            "Presidente Hayes": ["Villa Hayes", "Benjamín Aceval", "José Falcón", "Nanawa", "Puerto Pinasco", "Teniente Irala Fernández", "Teniente Esteban Martínez", "Vista Alegre"],
            "San Pedro": ["San Pedro de Ycuamandiyú", "Antequera", "Capiibary", "Choré", "General Elizardo Aquino", "General Francisco Isidoro Resquín", "Guayauí", "Itacurubí del Rosario", "Lima", "Nueva Germania", "San Estanislao", "San Pablo", "Santa Rosa del Aguaray", "Tacuatí", "Unión", "Veinticinco de Diciembre", "Villa del Rosario", "Yataity del Norte", "Yrybucuá"]
        };

        // Variables globales
        let currentStep = 1;
        let map;
        let marker;
        let selectedLat = -25.4481;
        let selectedLng = -56.4428;
        let selectedAddress = "Centro de Coronel Oviedo";
        let googleMapsLink = "https://maps.google.com/?q=-25.4481,-56.4428";
        let selectedPaymentMethod = '';
        let selectedShippingAgency = '';
        
        const products = {
            leche: { name: "Leche de Cabra Fresca", price: 25000, quantity: 0 },
            queso: { name: "Queso de Cabra", price: 180000, quantity: 0 },
            yogur: { name: "Yogur de Cabra Natural", price: 25000, quantity: 0 },
            dulce: { name: "Dulce de Leche de Cabra", price: 60000, quantity: 0 },
            kit: { name: "Kit de Degustación", price: 60000, quantity: 0 }
        };

        // Elementos del DOM
        const customerDepartment = document.getElementById('customerDepartment');
        const customerDistrict = document.getElementById('customerDistrict');
        const districtContainer = document.getElementById('districtContainer');
        const paymentMethodContainer = document.getElementById('paymentMethodContainer');
        const shippingAgencyContainer = document.getElementById('shippingAgencyContainer');
        const otherAgencyContainer = document.getElementById('otherAgencyContainer');
        const shippingAgency = document.getElementById('shippingAgency');
        const otherAgency = document.getElementById('otherAgency');
        const coronelOviedoMap = document.getElementById('coronelOviedoMap');
        const coronelOviedoReference = document.getElementById('coronelOviedoReference');
        const steps = document.querySelectorAll('.step');
        const progressBar = document.getElementById('progress-bar');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // Botones de navegación
        const nextToStep2 = document.getElementById('nextToStep2');
        const nextToStep3 = document.getElementById('nextToStep3');
        const backToStep1 = document.getElementById('backToStep1');
        const backToStep2 = document.getElementById('backToStep2');
        const sendOrder = document.getElementById('sendOrder');
        
        // ==================== INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar select de departamentos
            initializeDepartmentSelect();
            
            // Configurar evento para mostrar/ocultar elementos según departamento
            customerDepartment.addEventListener('change', handleDepartmentChange);
            
            // Configurar evento para distrito
            customerDistrict.addEventListener('change', handleDistrictChange);
            
            // Configurar opciones de pago
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('.bg-green-500').classList.add('hidden');
                    });
                    this.classList.add('selected');
                    this.querySelector('.bg-green-500').classList.remove('hidden');
                    selectedPaymentMethod = this.getAttribute('data-value');
                });
            });
            
            // Configurar agencia de envío
            shippingAgency.addEventListener('change', function() {
                selectedShippingAgency = this.value;
                if (this.value === 'otra') {
                    otherAgencyContainer.classList.remove('hidden');
                } else {
                    otherAgencyContainer.classList.add('hidden');
                }
            });
            
            // Inicializar botones de cantidad
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const product = e.target.closest('.quantity-btn').dataset.product;
                    const action = e.target.closest('.quantity-btn').dataset.action;
                    
                    if (action === 'increase') {
                        products[product].quantity++;
                    } else if (action === 'decrease' && products[product].quantity > 0) {
                        products[product].quantity--;
                    }
                    
                    document.getElementById(`${product}-quantity`).textContent = products[product].quantity;
                });
            });
        });

        // ==================== FUNCIONES DE UBICACIÓN ====================
        function initializeDepartmentSelect() {
            const departmentSelect = document.getElementById('customerDepartment');
            departmentSelect.innerHTML = '<option value="">Seleccione un departamento</option>';
            
            // Agregar departamentos
            Object.keys(paraguayLocations).forEach(department => {
                const option = document.createElement('option');
                option.value = department;
                option.textContent = department;
                departmentSelect.appendChild(option);
            });
        }

        function handleDepartmentChange() {
            const department = customerDepartment.value;
            
            // Ocultar todos los contenedores primero
            districtContainer.classList.add('hidden');
            paymentMethodContainer.classList.add('hidden');
            shippingAgencyContainer.classList.add('hidden');
            otherAgencyContainer.classList.add('hidden');
            coronelOviedoMap.style.display = 'none';
            coronelOviedoReference.classList.add('hidden');
            
            // Resetear valores
            selectedPaymentMethod = '';
            selectedShippingAgency = '';
            customerDistrict.value = '';
            
            if (department) {
                // Mostrar distritos
                customerDistrict.innerHTML = '<option value="">Seleccione distrito</option>';
                paraguayLocations[department].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    customerDistrict.appendChild(option);
                });
                
                districtContainer.classList.remove('hidden');
            }
        }

        function handleDistrictChange() {
            const district = customerDistrict.value;
            
            // Ocultar todos los contenedores primero
            paymentMethodContainer.classList.add('hidden');
            shippingAgencyContainer.classList.add('hidden');
            otherAgencyContainer.classList.add('hidden');
            coronelOviedoMap.style.display = 'none';
            coronelOviedoReference.classList.add('hidden');
            
            // Resetear valores
            selectedPaymentMethod = '';
            selectedShippingAgency = '';
            
            if (district) {
                // Verificar si es Coronel Oviedo
                const isCoronelOviedo = district === 'Coronel Oviedo' || district === 'Cnel. Oviedo';
                
                if (isCoronelOviedo) {
                    // SOLO para Coronel Oviedo: Mostrar Mapa + Referencia + Método de pago
                    paymentMethodContainer.classList.remove('hidden');
                    coronelOviedoMap.style.display = 'block';
                    coronelOviedoReference.classList.remove('hidden');
                    if (!map) {
                        initMap();
                    }
                } else {
                    // Para OTRAS ciudades: Mostrar SOLO Agencia de envío (NO mostrar referencia)
                    shippingAgencyContainer.classList.remove('hidden');
                }
            }
        }

        // ==================== VALIDACIÓN ====================
        function validateStep1() {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const department = customerDepartment.value;
            const district = customerDistrict.value;
            
            if (!name || !phone || !department || !district) {
                alert('❌ Por favor, complete todos los campos obligatorios.');
                return false;
            }
            
            // Validar formato de teléfono paraguayo
            const phoneRegex = /^(595|0)?9[0-9]{8}$/;
            const cleanPhone = phone.replace(/\s+/g, '').replace('+', '').replace('-', '');
            
            if (!phoneRegex.test(cleanPhone)) {
                alert('❌ Por favor ingresa un número de WhatsApp válido de Paraguay (ej: 0981123456)');
                return false;
            }
            
            // Validar método de pago para Coronel Oviedo
            const isCoronelOviedo = district === 'Coronel Oviedo' || district === 'Cnel. Oviedo';
            
            if (isCoronelOviedo) {
                if (!selectedPaymentMethod) {
                    alert('❌ Por favor seleccione un método de pago.');
                    return false;
                }
                
                // Validar referencia para Coronel Oviedo
                const referencia = document.getElementById('locationReference').value;
                if (!referencia) {
                    alert('❌ Por favor, ingrese una dirección o referencia para la entrega.');
                    return false;
                }
            } else {
                // Validar agencia de envío para otras ciudades
                if (!selectedShippingAgency) {
                    alert('❌ Por favor seleccione una agencia de envío.');
                    return false;
                }
                
                if (selectedShippingAgency === 'otra' && !otherAgency.value) {
                    alert('❌ Por favor especifique la agencia de envío.');
                    return false;
                }
            }
            
            return true;
        }

        function validateStep2() {
            let hasProducts = false;
            for (const product in products) {
                if (products[product].quantity > 0) {
                    hasProducts = true;
                    break;
                }
            }
            
            if (!hasProducts) {
                alert('❌ Por favor, seleccione al menos un producto.');
                return false;
            }
            
            return true;
        }

        function validateStep3() {
            return validateStep1() && validateStep2();
        }

        // ==================== FUNCIÓN PARA GUARDAR PEDIDO ====================
        async function guardarPedidoFirebase(pedidoData) {
            try {
                const pedidoId = 'PED' + Date.now();
                
                // Recolectar datos adicionales
                const department = customerDepartment.value;
                const district = customerDistrict.value;
                
                let paymentMethod = '';
                let shippingAgency = '';
                
                const isCoronelOviedo = district === 'Coronel Oviedo' || district === 'Cnel. Oviedo';
                
                if (isCoronelOviedo) {
                    paymentMethod = selectedPaymentMethod;
                } else {
                    shippingAgency = selectedShippingAgency;
                    if (shippingAgency === 'otra') {
                        shippingAgency = otherAgency.value;
                    }
                }
                
                const datosPedido = {
                    id: pedidoId,
                    cliente: pedidoData.nombre,
                    telefono: pedidoData.telefono,
                    ciudad: district,
                    departamento: department,
                    distrito: district,
                    direccion: district + ' - ' + (pedidoData.referencia || ''),
                    productos: pedidoData.productos,
                    total: pedidoData.total,
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    estado: 'pendiente',
                    repartidor: '',
                    metodoPago: paymentMethod,
                    agenciaEnvio: shippingAgency
                };

                // Si es Coronel Oviedo y hay datos del mapa, agregar coordenadas exactas
                if (isCoronelOviedo && map) {
                    datosPedido.direccion += ' | ' + selectedAddress;
                    datosPedido.coordenadas = {
                        lat: parseFloat(selectedLat),
                        lng: parseFloat(selectedLng)
                    };
                    datosPedido.mapa = googleMapsLink;
                }

                await db.collection('pedidos').doc(pedidoId).set(datosPedido);
                
                console.log('✅ Pedido guardado en Firebase:', pedidoId);
                return true;
                
            } catch (error) {
                console.error('❌ Error Firebase:', error);
                return false;
            }
        }

        // ==================== FUNCIÓN PRINCIPAL ====================
        async function enviarPedidoSistema() {
            if (!validateStep3()) {
                return false;
            }
            
            const pedidoData = {
                nombre: document.getElementById('customerName').value,
                telefono: document.getElementById('customerPhone').value,
                referencia: '',
                productos: [],
                total: 0,
                fecha: new Date().toLocaleString('es-PY')
            };

            // Obtener referencia según la ciudad
            const district = customerDistrict.value;
            const isCoronelOviedo = district === 'Coronel Oviedo' || district === 'Cnel. Oviedo';
            
            if (isCoronelOviedo) {
                pedidoData.referencia = document.getElementById('locationReference').value;
            } else {
                // Para otras ciudades, no usar referencia
                pedidoData.referencia = 'Entrega por agencia de envío';
            }

            // Obtener productos seleccionados
            let tieneProductos = false;
            for (const product in products) {
                if (products[product].quantity > 0) {
                    tieneProductos = true;
                    const subtotal = products[product].quantity * products[product].price;
                    pedidoData.total += subtotal;
                    pedidoData.productos.push({
                        nombre: products[product].name,
                        cantidad: products[product].quantity,
                        precio: products[product].price
                    });
                }
            }
            
            if (!tieneProductos) {
                alert('❌ Por favor selecciona al menos un producto');
                return false;
            }

            // Mostrar loading
            mostrarLoading();
            
            try {
                console.log('Enviando pedido a Firebase...');
                
                const success = await guardarPedidoFirebase(pedidoData);
                
                if (success) {
                    mostrarExito();
                } else {
                    mostrarError();
                }
                
                return success;
                
            } catch (error) {
                console.error('Error general:', error);
                mostrarError();
                return false;
            } finally {
                ocultarLoading();
            }
        }

        // ==================== FUNCIONES DE INTERFAZ ====================
        function mostrarLoading() {
            loadingOverlay.style.display = 'flex';
            sendOrder.disabled = true;
            sendOrder.innerHTML = '⏳ Enviando pedido...';
        }

        function ocultarLoading() {
            loadingOverlay.style.display = 'none';
            sendOrder.disabled = false;
            sendOrder.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Confirmar y Enviar Pedido';
        }

        function mostrarExito() {
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            sendOrder.disabled = true;
            sendOrder.innerHTML = '<i class="fas fa-check mr-2"></i> Pedido Enviado';
            sendOrder.classList.remove('btn-primary');
            sendOrder.classList.add('bg-gray-400', 'cursor-not-allowed');
            
            // Redirigir después de 5 segundos
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 5000);
        }

        function mostrarError() {
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        // ==================== MAPA ====================
        function initMap() {
            const oviedoCenter = [selectedLat, selectedLng];
            
            map = L.map('interactive-map').setView(oviedoCenter, 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Crear marcador inicial
            marker = L.marker(oviedoCenter, {
                draggable: true,
                icon: L.divIcon({
                    className: 'custom-marker',
                    iconSize: [20, 20]
                })
            }).addTo(map);
            
            // ZONAS PREDEFINIDAS DE CORONEL OVIEDO
            const zonasCoronelOviedo = [
                { coords: [-25.4481, -56.4428], nombre: 'Centro - Plaza Principal' },
                { coords: [-25.4410, -56.4400], nombre: 'Barrio San Miguel' },
                { coords: [-25.4550, -56.4350], nombre: 'Barrio Santa Teresa' },
                { coords: [-25.4380, -56.4500], nombre: 'Barrio San Antonio' },
                { coords: [-25.4600, -56.4300], nombre: 'Barrio San Roque' },
                { coords: [-25.4350, -56.4250], nombre: 'Barrio San Blas' },
                { coords: [-25.4300, -56.4550], nombre: 'Barrio San Pablo' },
                { coords: [-25.4650, -56.4450], nombre: 'Barrio San José' },
                { coords: [-25.4420, -56.4250], nombre: 'Barrio Santa Lucía' },
                { coords: [-25.4500, -56.4550], nombre: 'Barrio Virgen del Rosario' },
                { coords: [-25.4250, -56.4400], nombre: 'Barrio San Rafael' },
                { coords: [-25.4700, -56.4350], nombre: 'Barrio San Juan' }
            ];
            
            // Función para encontrar zona más cercana
            function encontrarZonaCercana(lat, lng) {
                let zonaMasCercana = 'Ubicación en Coronel Oviedo';
                let distanciaMinima = 0.02;
                
                for (const zona of zonasCoronelOviedo) {
                    const distancia = Math.sqrt(
                        Math.pow(lat - zona.coords[0], 2) + 
                        Math.pow(lng - zona.coords[1], 2)
                    );
                    
                    if (distancia < distanciaMinima) {
                        distanciaMinima = distancia;
                        zonaMasCercana = zona.nombre;
                    }
                }
                
                return zonaMasCercana;
            }
            
            // Función para actualizar ubicación
            function actualizarUbicacion(lat, lng) {
                selectedLat = lat.toFixed(6);
                selectedLng = lng.toFixed(6);
                googleMapsLink = `https://maps.google.com/?q=${selectedLat},${selectedLng}`;
                
                // Encontrar zona más cercana
                const zona = encontrarZonaCercana(lat, lng);
                selectedAddress = `${zona}`;
                
                updateLocationDisplay();
            }
            
            // Evento para actualizar ubicación al arrastrar
            marker.on('dragend', function(e) {
                const position = marker.getLatLng();
                actualizarUbicacion(position.lat, position.lng);
            });
            
            // Evento para actualizar ubicación al hacer clic
            map.on('click', function(e) {
                const position = e.latlng;
                actualizarUbicacion(position.lat, position.lng);
                marker.setLatLng(position);
            });
            
            updateLocationDisplay();
        }

        function updateLocationDisplay() {
            document.getElementById('selected-lat').textContent = selectedLat;
            document.getElementById('selected-lng').textContent = selectedLng;
            document.getElementById('location-link').textContent = googleMapsLink;
            document.getElementById('location-link').href = googleMapsLink;
            document.getElementById('selected-address').textContent = selectedAddress;
        }

        // ==================== SISTEMA DE PASOS ====================
        function changeStep(step) {
            steps.forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            
            // Actualizar la barra de progreso y los textos
            updateProgressBarAndLabels(step);
        }

        function updateProgressBar(percentage) {
            progressBar.style.width = `${percentage}%`;
        }

        // ==================== ACTUALIZAR BARRA DE PROGRESO Y ETIQUETAS ====================
        function updateProgressBarAndLabels(step) {
            // Actualizar la barra de progreso
            let percentage = 33;
            if (step === 2) percentage = 66;
            if (step === 3) percentage = 100;
            updateProgressBar(percentage);
            
            // Actualizar los textos de los pasos
            const step1Label = document.getElementById('step1-label');
            const step2Label = document.getElementById('step2-label');
            const step3Label = document.getElementById('step3-label');
            
            // Resetear todos los textos a gris
            step1Label.classList.remove('text-green-600');
            step1Label.classList.add('text-gray-500');
            step2Label.classList.remove('text-green-600');
            step2Label.classList.add('text-gray-500');
            step3Label.classList.remove('text-green-600');
            step3Label.classList.add('text-gray-500');
            
            // Aplicar color verde al paso actual y a los anteriores
            if (step >= 1) {
                step1Label.classList.remove('text-gray-500');
                step1Label.classList.add('text-green-600');
            }
            if (step >= 2) {
                step2Label.classList.remove('text-gray-500');
                step2Label.classList.add('text-green-600');
            }
            if (step >= 3) {
                step3Label.classList.remove('text-gray-500');
                step3Label.classList.add('text-green-600');
            }
        }

        // ==================== RESUMEN DEL PEDIDO ====================
        function updateOrderSummary() {
            document.getElementById('summary-name').textContent = document.getElementById('customerName').value;
            document.getElementById('summary-phone').textContent = document.getElementById('customerPhone').value;
            document.getElementById('summary-department').textContent = customerDepartment.value;
            document.getElementById('summary-district').textContent = customerDistrict.value;
            
            // Actualizar ubicación en el resumen
            const district = customerDistrict.value;
            const isCoronelOviedo = district === 'Coronel Oviedo' || district === 'Cnel. Oviedo';
            
            let locationText = '';
            let locationLink = '';
            
            if (isCoronelOviedo) {
                locationText = document.getElementById('locationReference').value;
                locationLink = googleMapsLink;
                document.getElementById('summary-location-link-container').classList.remove('hidden');
                document.getElementById('summary-location-link').href = locationLink;
                document.getElementById('summary-location-link').textContent = locationLink;
                document.getElementById('summary-payment-container').classList.remove('hidden');
                document.getElementById('summary-payment').textContent = selectedPaymentMethod === 'efectivo' ? '💵 Efectivo al recibir' : '🏦 Transferencia bancaria';
                document.getElementById('summary-shipping-container').classList.add('hidden');
            } else {
                // Para otras ciudades, no mostrar dirección/referencia en el resumen
                locationText = 'Entrega por agencia de envío';
                document.getElementById('summary-location-link-container').classList.add('hidden');
                document.getElementById('summary-payment-container').classList.add('hidden');
                document.getElementById('summary-shipping-container').classList.remove('hidden');
                let shippingText = selectedShippingAgency;
                if (selectedShippingAgency === 'otra') {
                    shippingText = otherAgency.value;
                }
                document.getElementById('summary-shipping').textContent = shippingText;
            }
            
            document.getElementById('summary-location').textContent = locationText;
            
            const productsSummary = document.getElementById('summary-products');
            productsSummary.innerHTML = '';
            
            let total = 0;
            for (const product in products) {
                if (products[product].quantity > 0) {
                    const productTotal = products[product].quantity * products[product].price;
                    total += productTotal;
                    
                    const productElement = document.createElement('div');
                    productElement.className = 'flex justify-between items-center py-2 border-b border-blue-100';
                    productElement.innerHTML = `
                        <span class="text-gray-700">${products[product].name} x${products[product].quantity}</span>
                        <span class="font-bold text-gray-800">Gs. ${productTotal.toLocaleString()}</span>
                    `;
                    productsSummary.appendChild(productElement);
                }
            }
            
            document.getElementById('summary-total').textContent = `Gs. ${total.toLocaleString()}`;
        }

        // ==================== EVENT LISTENERS ====================
        nextToStep2.addEventListener('click', () => {
            if (validateStep1()) {
                changeStep(2);
            }
        });

        nextToStep3.addEventListener('click', () => {
            if (validateStep2()) {
                updateOrderSummary();
                changeStep(3);
            }
        });

        backToStep1.addEventListener('click', () => {
            changeStep(1);
        });

        backToStep2.addEventListener('click', () => {
            changeStep(2);
        });

        // Botón de enviar pedido
        sendOrder.addEventListener('click', async (e) => {
            e.preventDefault();
            await enviarPedidoSistema();
        }); 
    </script>
</body>
</html>
